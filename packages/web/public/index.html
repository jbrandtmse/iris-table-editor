<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Fallback CSP for when server-side helmet is not active (e.g., static file serving).
         When helmet is active, the server's CSP header also applies (browsers enforce ALL policies).
         The server CSP adds ws:/wss: to connect-src for WebSocket support. -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self' ws: wss:;">
    <title>IRIS Table Editor</title>
    <!-- Loading spinner styles: inline to show before external CSS loads (Story 19.5) -->
    <style>
        .ite-loading{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:var(--ite-theme-bg,#1e1e1e);color:var(--ite-theme-fg,#d4d4d4);font-family:system-ui,-apple-system,sans-serif}
        .ite-loading__spinner{width:40px;height:40px;border:3px solid rgba(128,128,128,0.3);border-top-color:#007acc;border-radius:50%;animation:ite-loading-spin .8s linear infinite}
        @keyframes ite-loading-spin{to{transform:rotate(360deg)}}
        .ite-loading__text{margin-top:16px;font-size:14px;opacity:0.7}
    </style>
    <!-- Web theme bridge FIRST: provides --ite-* variables for light/dark themes (Story 17.3) -->
    <link rel="stylesheet" href="webThemeBridge.css">
    <!-- Theme initialization: sets data-theme before first paint to prevent flash (Story 17.3) -->
    <script src="theme.js"></script>
    <link rel="stylesheet" href="connection-form.css">
    <!-- Webview theme and styles (served from /webview/) -->
    <link rel="stylesheet" href="/webview/theme.css">
    <link rel="stylesheet" href="/webview/styles.css">
    <link rel="stylesheet" href="/webview/grid-styles.css">
</head>
<body>
    <noscript>
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:system-ui,-apple-system,sans-serif;background:#1e1e1e;color:#d4d4d4;">
            <div style="text-align:center;padding:2rem;">
                <h1 style="font-size:1.5rem;margin-bottom:1rem;">JavaScript Required</h1>
                <p>JavaScript is required to use IRIS Table Editor. Please enable JavaScript in your browser settings.</p>
            </div>
        </div>
    </noscript>
    <div id="ite-loading" class="ite-loading">
        <div class="ite-loading__spinner"></div>
        <p class="ite-loading__text">Loading IRIS Table Editor...</p>
    </div>
    <div class="ite-page">
        <!-- Reconnection Banner (Story 16.5, Task 3.6) -->
        <div class="ite-reconnect-banner" id="reconnectBanner" role="alert" aria-live="assertive" hidden>
            <span class="ite-reconnect-banner__message" id="reconnectMessage">Connection lost. Reconnecting...</span>
            <button class="ite-button ite-button--secondary ite-reconnect-banner__refresh" id="reconnectRefreshBtn" hidden>
                Refresh
            </button>
        </div>

        <div class="ite-page__header">
            <h1 class="ite-page__title">IRIS Table Editor</h1>
            <button class="ite-theme-toggle" id="themeToggle" type="button"
                    aria-label="Toggle dark mode" title="Toggle dark mode">
                <span class="ite-theme-toggle__icon" id="themeToggleIcon" aria-hidden="true"></span>
            </button>
        </div>

        <div class="ite-page__content">
            <!-- Connection Form View -->
            <div id="connectionView" class="ite-connection-form">
                <h2 class="ite-connection-form__title">Connect to IRIS Server</h2>

                <form class="ite-connection-form__body" id="connectionForm" novalidate autocomplete="off">
                    <!-- Host -->
                    <div class="ite-connection-form__field" data-field="host">
                        <label class="ite-connection-form__label" for="fieldHost">
                            Host <span class="ite-connection-form__required" aria-hidden="true">*</span>
                        </label>
                        <input class="ite-connection-form__input" type="text" id="fieldHost" name="host"
                               required placeholder="e.g., localhost or 192.168.1.100"
                               aria-required="true" aria-describedby="fieldHostError">
                        <span class="ite-connection-form__error" id="fieldHostError" role="alert" aria-live="polite"></span>
                    </div>

                    <!-- Port -->
                    <div class="ite-connection-form__field" data-field="port">
                        <label class="ite-connection-form__label" for="fieldPort">
                            Port <span class="ite-connection-form__required" aria-hidden="true">*</span>
                        </label>
                        <input class="ite-connection-form__input" type="number" id="fieldPort" name="port"
                               required value="52773" min="1" max="65535"
                               aria-required="true" aria-describedby="fieldPortError">
                        <span class="ite-connection-form__error" id="fieldPortError" role="alert" aria-live="polite"></span>
                    </div>

                    <!-- Path Prefix -->
                    <div class="ite-connection-form__field" data-field="pathPrefix">
                        <label class="ite-connection-form__label" for="fieldPathPrefix">Path Prefix</label>
                        <input class="ite-connection-form__input" type="text" id="fieldPathPrefix" name="pathPrefix"
                               placeholder="e.g., /iris">
                    </div>

                    <!-- Namespace -->
                    <div class="ite-connection-form__field" data-field="namespace">
                        <label class="ite-connection-form__label" for="fieldNamespace">
                            Namespace <span class="ite-connection-form__required" aria-hidden="true">*</span>
                        </label>
                        <input class="ite-connection-form__input" type="text" id="fieldNamespace" name="namespace"
                               required placeholder="e.g., USER"
                               aria-required="true" aria-describedby="fieldNamespaceError">
                        <span class="ite-connection-form__error" id="fieldNamespaceError" role="alert" aria-live="polite"></span>
                    </div>

                    <!-- Use HTTPS -->
                    <div class="ite-connection-form__field ite-connection-form__field--checkbox" data-field="useHTTPS">
                        <label class="ite-connection-form__checkbox-label">
                            <input class="ite-connection-form__checkbox" type="checkbox" id="fieldUseHTTPS" name="useHTTPS">
                            <span class="ite-connection-form__checkbox-text">Use HTTPS</span>
                        </label>
                    </div>

                    <!-- Username -->
                    <div class="ite-connection-form__field" data-field="username">
                        <label class="ite-connection-form__label" for="fieldUsername">
                            Username <span class="ite-connection-form__required" aria-hidden="true">*</span>
                        </label>
                        <input class="ite-connection-form__input" type="text" id="fieldUsername" name="username"
                               required placeholder="e.g., _SYSTEM"
                               aria-required="true" aria-describedby="fieldUsernameError">
                        <span class="ite-connection-form__error" id="fieldUsernameError" role="alert" aria-live="polite"></span>
                    </div>

                    <!-- Password -->
                    <div class="ite-connection-form__field" data-field="password">
                        <label class="ite-connection-form__label" for="fieldPassword">
                            Password <span class="ite-connection-form__required" aria-hidden="true">*</span>
                        </label>
                        <input class="ite-connection-form__input" type="password" id="fieldPassword" name="password"
                               required placeholder="Enter password"
                               aria-required="true" aria-describedby="fieldPasswordError">
                        <span class="ite-connection-form__error" id="fieldPasswordError" role="alert" aria-live="polite"></span>
                    </div>

                    <!-- Remember Connection -->
                    <div class="ite-connection-form__field ite-connection-form__field--checkbox" data-field="remember">
                        <label class="ite-connection-form__checkbox-label">
                            <input class="ite-connection-form__checkbox" type="checkbox" id="fieldRemember" name="remember">
                            <span class="ite-connection-form__checkbox-text">Remember connection</span>
                        </label>
                    </div>

                    <!-- Form Message -->
                    <div class="ite-connection-form__message" id="formMessage" role="alert" aria-live="polite"></div>

                    <!-- Form Actions -->
                    <div class="ite-connection-form__actions">
                        <button class="ite-button ite-button--primary" type="submit" id="connectBtn">
                            <span class="ite-connection-form__spinner" id="connectSpinner"></span>
                            <span id="connectBtnText">Connect</span>
                        </button>
                        <button class="ite-button ite-button--secondary ite-connection-form__test-btn" type="button" id="testBtn">
                            <span class="ite-connection-form__spinner" id="testSpinner"></span>
                            <span id="testBtnText">Test Connection</span>
                        </button>
                        <button class="ite-button ite-button--secondary ite-connection-form__cancel-test-btn" type="button" id="cancelTestBtn" hidden>
                            Cancel
                        </button>
                    </div>

                    <!-- Test Connection Result -->
                    <div class="ite-connection-form__test-result" id="testResult" role="status" aria-live="polite"></div>
                </form>

                <!-- Recent Connections -->
                <div class="ite-recent-connections" id="recentConnections" hidden>
                    <h3 class="ite-recent-connections__title">Recent Connections</h3>
                    <ul class="ite-recent-connections__list" id="recentList" role="list"></ul>
                </div>
            </div>

            <!-- Connected View -->
            <div id="connectedView" class="ite-connected-view" hidden>
                <!-- Connection Header Bar -->
                <div class="ite-connection-header" id="connectionHeader">
                    <span class="ite-connection-header__info" id="connectionInfo"></span>
                    <button class="ite-button ite-button--secondary ite-connection-header__disconnect" id="disconnectBtn">
                        Disconnect
                    </button>
                </div>

                <!-- Shared webview UI (Story 17.1) -->
                <div class="ite-connected-view__body">
                    <!-- Sidebar: namespace/table selection (rendered by main.js) -->
                    <div class="ite-container">
                        <!-- Webview main.js renders server/namespace/table selection here -->
                    </div>

                    <!-- Grid area: toolbar, data grid, pagination (used by grid.js) -->
                    <div class="ite-grid-container" id="gridContainer" style="display: none;">
                        <div class="ite-toolbar">
                            <button class="ite-toolbar__button" id="refreshBtn" title="Refresh data">&#x21bb;</button>
                            <button class="ite-toolbar__button" id="addRowBtn" title="Add new row (Ctrl+N)">+</button>
                            <button class="ite-toolbar__button" id="saveRowBtn" title="Save new row (Ctrl+S)" disabled>&#x1f4be;</button>
                            <button class="ite-toolbar__button" id="deleteRowBtn" title="Delete row (Del)" disabled>&#x1f5d1;</button>
                            <span class="ite-toolbar__separator"></span>
                            <button class="ite-toolbar__button" id="clearFiltersBtn" title="Clear all filters" disabled>&#x2715;</button>
                            <button class="ite-toolbar__button" id="toggleFiltersBtn" title="Disable filters">&#x1f50d;</button>
                            <button class="ite-toolbar__button" id="filterPanelBtn" title="Filter panel">
                                &#x2261;
                                <span class="ite-toolbar__badge" id="filterBadge" style="display: none;">0</span>
                            </button>
                            <span class="ite-toolbar__separator"></span>
                            <div class="ite-toolbar__slider-group">
                                <span title="Column width">W</span>
                                <input type="range" id="columnWidthSlider" class="ite-toolbar__slider"
                                       min="80" max="400" value="150" title="Adjust column width" />
                            </div>
                            <!-- Filter Panel (hidden by default) -->
                            <div class="ite-filter-panel" id="filterPanel" style="display: none;">
                                <div class="ite-filter-panel__header">
                                    <h4 class="ite-filter-panel__title">Active Filters</h4>
                                    <button class="ite-filter-panel__close" id="filterPanelClose" title="Close panel">&times;</button>
                                </div>
                                <div class="ite-filter-panel__content" id="filterPanelContent">
                                    <p class="ite-filter-panel__empty">No active filters</p>
                                </div>
                            </div>
                        </div>

                        <div class="ite-grid-loading" id="loadingOverlay" style="display: flex;">
                            <div class="ite-loading__spinner"></div>
                            <p class="ite-loading__text">Loading table data...</p>
                        </div>

                        <div class="ite-grid-wrapper" id="gridWrapper" style="display: none;">
                            <div class="ite-grid" id="dataGrid" role="grid" aria-label="Table data"></div>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="ite-pagination" id="paginationContainer" role="navigation" aria-label="Table pagination" style="display: none;">
                            <span class="ite-pagination__info" id="paginationInfo" aria-live="polite">Rows 1-50 of 0</span>
                            <div class="ite-pagination__controls">
                                <button class="ite-pagination__button ite-pagination__button--icon"
                                        id="firstPageBtn" aria-label="First page" title="First page" disabled>&#9198;</button>
                                <button class="ite-pagination__button ite-pagination__button--icon"
                                        id="prevPageBtn" aria-label="Previous page" title="Previous page" disabled>&#9664;</button>
                                <div class="ite-pagination__page-input-container">
                                    <input type="text" class="ite-pagination__page-input" id="pageInput"
                                           aria-label="Page number" value="1" />
                                    <span class="ite-pagination__page-total" id="pageTotalLabel">of 1</span>
                                </div>
                                <button class="ite-pagination__button ite-pagination__button--icon"
                                        id="nextPageBtn" aria-label="Next page" title="Next page">&#9654;</button>
                                <button class="ite-pagination__button ite-pagination__button--icon"
                                        id="lastPageBtn" aria-label="Last page" title="Last page">&#9197;</button>
                            </div>
                        </div>

                        <!-- Toast notification container -->
                        <div id="toastContainer" class="ite-toast-container" aria-live="assertive" aria-atomic="true"></div>

                        <!-- Delete confirmation dialog -->
                        <div class="ite-dialog-overlay" id="deleteDialogOverlay" style="display: none;" role="presentation">
                            <div class="ite-dialog" role="dialog" aria-modal="true" aria-labelledby="deleteDialogTitle" aria-describedby="deleteDialogDesc">
                                <div class="ite-dialog__content">
                                    <h2 id="deleteDialogTitle" class="ite-dialog__title">Delete Row</h2>
                                    <p id="deleteDialogDesc" class="ite-dialog__message">Delete this row? This action cannot be undone.</p>
                                </div>
                                <div class="ite-dialog__actions">
                                    <button type="button" class="ite-dialog__button ite-dialog__button--secondary" id="deleteDialogCancel">Cancel</button>
                                    <button type="button" class="ite-dialog__button ite-dialog__button--danger" id="deleteDialogConfirm">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ARIA live region for screen reader announcements -->
    <div id="ite-live-region" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <script src="connection-form.js"></script>
    <script src="ws-reconnect.js"></script>
    <!-- WebMessageBridge must load BEFORE webview scripts (sets window.iteMessageBridge) -->
    <script src="WebMessageBridge.js"></script>
    <script src="spa-router.js"></script>
    <!-- Shared webview scripts (served from /webview/) -->
    <script src="/webview/main.js"></script>
    <script src="/webview/grid.js"></script>
</body>
</html>
